[{
  "id": "Example_PlaceHolder_ID",
  "version": "2024020714",
  "title": "Example_PlaceHolder_Title",
  "wordCount": 0,
  "subEntries": [
    {
      "id": "Examples_General_Magm_Python_magm_py",
      "version": "2024020714",
      "title": "magm.py",
      "location": "Sample Code from MIL Examples",
      "text": " Top #!/usr/bin/env python3 # -*- coding: utf-8 -*- ########################################################################## # # File name: Magm.py # # Synopsis: This program consists of 2 examples that use the AGM module # to define a model and search for model occurrences in target images. # The first example extracts a single-definition model from a source image, # then quickly finds occurrences in a cluttered target image. # The second example constructs a composite-definition model through training, # then finds occurrences with slight variations in appearance in different target images. # # Copyright (C) Matrox Electronic Systems Ltd., 1992-2024. # All Rights Reserved import mil as MIL # Path definitions. EXAMPLE_IMAGE_DIR_PATH = MIL.M_IMAGE_PATH + \"/Magm/\" MODEL_IMAGE_0_PATH = EXAMPLE_IMAGE_DIR_PATH + \"CircuitPinsModel.mim\" MODEL_IMAGE_1_PATH = EXAMPLE_IMAGE_DIR_PATH + \"SwitchModel.mim\" TARGET_IMAGE_0_PATH = EXAMPLE_IMAGE_DIR_PATH + \"CircuitBoardTarget.mim\" TARGET_IMAGE_1_PATH = EXAMPLE_IMAGE_DIR_PATH + \"SwitchTarget.mim\" TRAIN_IMAGES_0_PATH = EXAMPLE_IMAGE_DIR_PATH + \"LabeledTrainImages0.mbufc\" TRAIN_IMAGES_1_PATH = EXAMPLE_IMAGE_DIR_PATH + \"LabeledTrainImages1.mbufc\" TEST_IMAGES_DIR_0_PATH = EXAMPLE_IMAGE_DIR_PATH + \"Testset0/\" TEST_IMAGES_DIR_1_PATH = EXAMPLE_IMAGE_DIR_PATH + \"Testset1/\" # Execute Single-definition model example. def ExecuteSingleModelExample( MilSystem, MilModelDisplay, MilTargetDisplay, ModelImagePath, TargetImagePath, DetectionSearchAngleDeltaPos = 0.0): # Allocate a graphic list to hold the subpixel annotations to draw. MilGraphicList = MIL.MgraAllocList(MilSystem, MIL.M_DEFAULT) # Associate the graphic list to the display for annotations. MIL.MdispControl(MilTargetDisplay, MIL.M_ASSOCIATED_GRAPHIC_LIST_ID, MilGraphicList) # Restore the model image and display it. MilModelImage = MIL.MbufRestore(ModelImagePath, MilSystem) # Make the display a little bigger since the image is small. ModelWindowSizeX = MIL.MbufInquire(MilModelImage, MIL.M_SIZE_X, MIL.M_NULL) + 150; ModelWindowSizeX = MIL.MbufInquire(MilModelImage, MIL.M_SIZE_Y, MIL.M_NULL) + 150; MIL.MdispControl(MilModelDisplay, MIL.M_WINDOW_INITIAL_SIZE_X, ModelWindowSizeX); MIL.MdispControl(MilModelDisplay, MIL.M_WINDOW_INITIAL_SIZE_Y, ModelWindowSizeX); # Sets the initial, left-most, X-coordinate of the model disaplay and target display MIL.MdispControl(MilModelDisplay, MIL.M_WINDOW_INITIAL_POSITION_X, 10); MIL.MdispControl(MilModelDisplay, MIL.M_WINDOW_INITIAL_POSITION_Y, 10); MIL.MdispControl(MilTargetDisplay, MIL.M_WINDOW_INITIAL_POSITION_X, ModelWindowSizeX + 90); MIL.MdispControl(MilTargetDisplay, MIL.M_WINDOW_INITIAL_POSITION_Y, 10); # Display the model image. MIL.MdispSelect(MilModelDisplay, MilModelImage) print(\"A single-definition model was defined from the displayed model image.\\n\"); # Allocate a find AGM context. MilFindContext = MIL.MagmAlloc(MilSystem, MIL.M_GLOBAL_EDGE_BASED_FIND, MIL.M_DEFAULT) # Allocate a find AGM result buffer. MilSearchResult = MIL.MagmAllocResult(MilSystem, MIL.M_GLOBAL_EDGE_BASED_FIND_RESULT, MIL.M_DEFAULT) # Define the single-definition model. MIL.MagmDefine(MilFindContext, MIL.M_ADD, MIL.M_DEFAULT, MIL.M_SINGLE, MilModelImage, MIL.M_DEFAULT) # Set the minimum acceptable detection score. MIL.MagmControl(MilFindContext, MIL.M_AGM_MODEL_INDEX(0), MIL.M_ACCEPTANCE_DETECTION, 75) # Set the search angle range for the detection. MIL.MagmControl(MilFindContext, MIL.M_AGM_MODEL_INDEX(0), MIL.M_DETECTION_DELTA_POS_ANGLE, DetectionSearchAngleDeltaPos); # Preprocess the find AGM context. MIL.MagmPreprocess(MilFindContext, MIL.M_DEFAULT) # Restore the target image. MilTargetImage = MIL.MbufRestore(TargetImagePath, MilSystem) # Reset the time. MIL.MappTimer(MIL.M_DEFAULT, MIL.M_TIMER_RESET + MIL.M_SYNCHRONOUS, MIL.M_NULL) # Find the model. MIL.MagmFind(MilFindContext, MilTargetImage, MilSearchResult, MIL.M_DEFAULT) # Read the find time. FindTime = MIL.MappTimer(MIL.M_DEFAULT, MIL.M_TIMER_READ + MIL.M_SYNCHRONOUS) # Get the number of occurrences found. NumOccurrences = MIL.MagmGetResult(MilSearchResult, MIL.M_DEFAULT, MIL.M_NUMBER) if NumOccurrences &gt; 0: XPositions = MIL.MagmGetResult(MilSearchResult, MIL.M_ALL, MIL.M_POSITION_X) YPositions = MIL.MagmGetResult(MilSearchResult, MIL.M_ALL, MIL.M_POSITION_Y) DetectionScores = MIL.MagmGetResult(MilSearchResult, MIL.M_ALL, MIL.M_SCORE_DETECTION) FitScores = MIL.MagmGetResult(MilSearchResult, MIL.M_ALL, MIL.M_SCORE_FIT) CoverageScores = MIL.MagmGetResult(MilSearchResult, MIL.M_ALL, MIL.M_SCORE_COVERAGE) # Print the results for each occurrence found. print(\"The model was found in the target image:\\n\") print(\"Result X Position Y Position DetectionScore FitScore CoverageScore\\n\") for n in range(NumOccurrences): print(\"{:&lt;9}{:&lt;13.2f}{:&lt;13.2f}{:&lt;17.2f}{:&lt;11.2f}{:&lt;11.2f}\" .format(int(n), XPositions[n], YPositions[n], DetectionScores[n], FitScores[n], CoverageScores[n])) print(\"\\nNumber of occurrences found in the target image: {}\".format(int(NumOccurrences))) print(\"Search time: {:.1f} ms\".format(FindTime * 1000.0)) # Draw green edges and bounding boxes over the occurrences that were found. MIL.MgraControl(MIL.M_DEFAULT, MIL.M_COLOR, MIL.M_COLOR_GREEN) MIL.MagmDraw(MIL.M_DEFAULT, MilSearchResult, MilGraphicList, MIL.M_DRAW_EDGES + MIL.M_DRAW_BOX, MIL.M_ALL, MIL.M_DEFAULT) # Draw red positions over the occurrences that were found. MIL.MgraControl(MIL.M_DEFAULT, MIL.M_COLOR, MIL.M_COLOR_RED) MIL.MagmDraw(MIL.M_DEFAULT, MilSearchResult, MilGraphicList, MIL.M_DRAW_POSITION, MIL.M_ALL, MIL.M_DEFAULT) else : print(\"The model was not found in the target image\") # Display the target image. MIL.MdispSelect(MilTargetDisplay, MilTargetImage) print(\"Press any key to continue.\\n\") MIL.MosGetch() # Put the display back to its default state. MIL.MdispControl(MilModelDisplay, MIL.M_WINDOW_INITIAL_SIZE_X, MIL.M_DEFAULT); MIL.MdispControl(MilModelDisplay, MIL.M_WINDOW_INITIAL_SIZE_Y, MIL.M_DEFAULT); # Remove the display. MIL.MdispSelect(MilModelDisplay , MIL.M_NULL); MIL.MdispSelect(MilTargetDisplay, MIL.M_NULL); # Free MIL objects. MIL.MgraFree(MilGraphicList) MIL.MagmFree(MilFindContext) MIL.MagmFree(MilSearchResult) MIL.MbufFree(MilModelImage) MIL.MbufFree(MilTargetImage) # Single-definition model example. def SingleModelExample(MilSystem): print(\"This example shows that AGM is able to quickly find occurrences\") print(\"in a large cluttered target image.\") print(\"Press any key to continue.\\n\") MIL.MosGetch() # Allocate the model and target displays MilModelDisplay = MIL.MdispAlloc(MilSystem, MIL.M_DEFAULT, \"M_DEFAULT\", MIL.M_DEFAULT); MilTargetDisplay = MIL.MdispAlloc(MilSystem, MIL.M_DEFAULT, \"M_DEFAULT\", MIL.M_DEFAULT); # Set the model and target display's titles MIL.MdispControl(MilModelDisplay , MIL.M_TITLE, \"Model\"); MIL.MdispControl(MilTargetDisplay, MIL.M_TITLE, \"Target\"); ExecuteSingleModelExample(MilSystem, MilModelDisplay, MilTargetDisplay, MODEL_IMAGE_0_PATH, TARGET_IMAGE_0_PATH); print(\"AGM can also find orriented occurrences.\\n\"); ExecuteSingleModelExample(MilSystem, MilModelDisplay, MilTargetDisplay, MODEL_IMAGE_1_PATH, TARGET_IMAGE_1_PATH, 360.0); MIL.MdispFree(MilModelDisplay) MIL.MdispFree(MilTargetDisplay) # Execute Composite-definition model example. def ExecuteCompositeModelExample( MilSystem, MilDisplay, TrainImagesPath, TestImagesPath, RealignStrength = 0.0): # Restore the training images. TrainImagesContainer = MIL.MbufRestore(TrainImagesPath, MilSystem) # Print message about training image labels. print(\"\\n*******************************************************\") print(\"LOADING LABELED TRAINING IMAGES...\") print(\"*******************************************************\") print(\"Training requires labeled images with positive and negative samples.\") print(\"Positive samples are occurrences delimited by blue boxes and\") print(\"negative samples are background parts delimited by red boxes.\") print(\"Typically, when false positives are detected in training images,\") print(\"they should be used as negative samples to improve the training.\") print(\"To ease the labeling of images, use the example AgmLabelingTool.\") # Wait for a key to be pressed. print(\"\\nPress any key to show the labeled images used in this training.\") MIL.MosGetch() # Get the components from the container. NumTrainImage = MIL.MbufInquireContainer(TrainImagesContainer, MIL.M_CONTAINER, MIL.M_COMPONENT_LIST + MIL.M_NB_ELEMENTS) TrainImages = MIL.MbufInquireContainer(TrainImagesContainer, MIL.M_CONTAINER, MIL.M_COMPONENT_LIST) # Allocate a graphic list to hold the subpixel annotations to draw. Regions = MIL.MgraAllocList(MilSystem, MIL.M_DEFAULT) # Associate the graphic list to the display for annotations. MIL.MdispControl(MilDisplay, MIL.M_ASSOCIATED_GRAPHIC_LIST_ID, Regions) # Display each labeled training image. print(\"\\nOnly positive samples are given because AGM is able\"); print(\"to automatically generate negative samples.\\n\"); for n in range(NumTrainImage): MIL.MgraClear(MIL.M_DEFAULT, Regions) MIL.MbufSetRegion(TrainImages[n], Regions, MIL.M_DEFAULT, MIL.M_EXTRACT, MIL.M_DEFAULT) MIL.MdispSelect(MilDisplay, TrainImages[n]) print(\"Training image {}/{}\".format(int(n+1), int(NumTrainImage))) print(\"Press any key to continue.\") MIL.MosGetch() # Disassociate the graphic list from the display and stop displaying the training images. MIL.MdispControl(MilDisplay, MIL.M_ASSOCIATED_GRAPHIC_LIST_ID, MIL.M_NULL) MIL.MdispSelect(MilDisplay, MIL.M_NULL) # Allocate a find AGM context. MilFindContext = MIL.MagmAlloc(MilSystem, MIL.M_GLOBAL_EDGE_BASED_FIND, MIL.M_DEFAULT) # Allocate a find AGM result buffer. MilSearchResult = MIL.MagmAllocResult(MilSystem, MIL.M_GLOBAL_EDGE_BASED_FIND_RESULT, MIL.M_DEFAULT) # Allocate a train AGM context. MilTrainContext = MIL.MagmAlloc(MilSystem, MIL.M_GLOBAL_EDGE_BASED_TRAIN, MIL.M_DEFAULT) # Allocate a train AGM result buffer. MilTrainResult = MIL.MagmAllocResult(MilSystem, MIL.M_GLOBAL_EDGE_BASED_TRAIN_RESULT, MIL.M_DEFAULT) # Define the composite-definition model. MIL.MagmDefine(MilTrainContext, MIL.M_ADD, MIL.M_DEFAULT, MIL.M_COMPOSITE, MIL.M_NULL, MIL.M_DEFAULT) # Enable the automatic generation of negative labels. MIL.MagmControl(MilTrainContext, MIL.M_AGM_MODEL_INDEX(0), MIL.M_NEGATIVE_LABELS_MODE, MIL.M_AUTO); # Set the realignment of positive labels. MIL.MagmControl(MilTrainContext, MIL.M_AGM_MODEL_INDEX(0), MIL.M_REALIGN_STRENGTH, RealignStrength); # Preprocess the train AGM context. MIL.MagmPreprocess(MilTrainContext, MIL.M_DEFAULT) # Train the composite-definition model. print(\"\\n*******************************************************\") print(\"TRAINING... THIS WILL TAKE SOME TIME...\") print(\"*******************************************************\") TrainImagesContainerPtr = [TrainImagesContainer] MIL.MagmTrain(MilTrainContext, TrainImagesContainerPtr, 1, MilTrainResult, MIL.M_DEFAULT) # Check that the training process completed successfully. TrainStatus = MIL.MagmGetResult(MilTrainResult, MIL.M_DEFAULT, MIL.M_STATUS) if TrainStatus == MIL.M_COMPLETE: print(\"Training complete!\") # Ensure that the trained model is valid before copying to the find AGM context. TrainedModelStatus = MIL.MagmGetResult(MilTrainResult, MIL.M_AGM_MODEL_INDEX(0), MIL.M_STATUS) if TrainedModelStatus == MIL.M_STATUS_TRAIN_OK : # Display all the positive and negative labels on the training images. print(\"Here are the training images with the positive labels\"); print(\"and the automatically generated negative labels.\\n\"); MIL.MdispControl(MilDisplay, MIL.M_ASSOCIATED_GRAPHIC_LIST_ID, Regions); for i in range(NumTrainImage): MIL.MgraClear(MIL.M_DEFAULT, Regions); MIL.MgraColor(MIL.M_DEFAULT, MIL.M_COLOR_BLUE); MIL.MagmDraw(MIL.M_DEFAULT, MilTrainResult, Regions, MIL.M_DRAW_POS_RECTANGLES, MIL.M_AGM_IMAGE_INDEX(i), MIL.M_DEFAULT); MIL.MgraColor(MIL.M_DEFAULT, MIL.M_COLOR_RED); MIL.MagmDraw(MIL.M_DEFAULT, MilTrainResult, Regions, MIL.M_DRAW_NEG_RECTANGLES, MIL.M_AGM_IMAGE_INDEX(i), MIL.M_DEFAULT); MIL.MdispSelect(MilDisplay, TrainImages[i]); print(\"Training image {}/{}\".format(int(i+1), int(NumTrainImage))) print(\"Press any key to continue.\"); MIL.MosGetch() # Disassociate the graphic list from the display and stop displaying the training images. MIL.MdispControl(MilDisplay, MIL.M_ASSOCIATED_GRAPHIC_LIST_ID, MIL.M_NULL); MIL.MdispSelect(MilDisplay, MIL.M_NULL); # Copy the trained model to a find AGM context. MIL.MagmCopyResult(MilTrainResult, MIL.M_DEFAULT, MilFindContext, MIL.M_DEFAULT, MIL.M_TRAINED_MODEL, MIL.M_DEFAULT) # Preprocess find AGM context. MIL.MagmPreprocess(MilFindContext, MIL.M_DEFAULT) print(\"\\n*******************************************************\") print(\"FINDING WITH THE TRAINED MODEL...\") print(\"*******************************************************\") # Restore test images. FilesToSearch = TestImagesPath + \"*.mim\" NumberOfImages = MIL.MappFileOperation(MIL.M_DEFAULT, FilesToSearch, MIL.M_NULL, MIL.M_NULL, MIL.M_FILE_NAME_FIND+MIL.M_NB_ELEMENTS, MIL.M_DEFAULT) TestImages = [] for n in range(NumberOfImages): Filename = MIL.MappFileOperation(MIL.M_DEFAULT, FilesToSearch, MIL.M_NULL, MIL.M_NULL, MIL.M_FILE_NAME_FIND, n) FilePath = TestImagesPath + Filename TestImages.append(MIL.MbufRestore(FilePath, MilSystem)) # Allocate a graphic list to hold the subpixel annotations to draw. MilGraphicList = MIL.MgraAllocList(MilSystem, MIL.M_DEFAULT) # Associate the graphic list to the display for annotations. MIL.MdispControl(MilDisplay, MIL.M_ASSOCIATED_GRAPHIC_LIST_ID, MilGraphicList) # Assign the color to draw. MIL.MgraControl(MIL.M_DEFAULT, MIL.M_COLOR, MIL.M_COLOR_GREEN) for n in range(NumberOfImages): # Find the model in the test image. MIL.MagmFind(MilFindContext, TestImages[n], MilSearchResult, MIL.M_DEFAULT) # Get the number of occurrences found. NumOccurrences = MIL.MagmGetResult(MilSearchResult, MIL.M_DEFAULT, MIL.M_NUMBER + MIL.M_TYPE_MIL_INT) if NumOccurrences &gt; 0: # Get the results of the search. XPositions = MIL.MagmGetResult(MilSearchResult, MIL.M_ALL, MIL.M_POSITION_X) YPositions = MIL.MagmGetResult(MilSearchResult, MIL.M_ALL, MIL.M_POSITION_Y) DetectionScores = MIL.MagmGetResult(MilSearchResult, MIL.M_ALL, MIL.M_SCORE_DETECTION) FitScores = MIL.MagmGetResult(MilSearchResult, MIL.M_ALL, MIL.M_SCORE_FIT) CoverageScores = MIL.MagmGetResult(MilSearchResult, MIL.M_ALL, MIL.M_SCORE_COVERAGE) # Print the results for each occurrence foud. print(\"The model was found in the target image:\\n\") print(\"Result X Position Y Position DetectionScore FitScore CoverageScore\\n\") for k in range(NumOccurrences): print(\"{:&lt;9}{:&lt;13.2f}{:&lt;13.2f}{:&lt;17.2f}{:&lt;11.2f}{:&lt;11.2f}\" .format(int(k), XPositions[k], YPositions[k], DetectionScores[k], FitScores[k], CoverageScores[k])) # Empty the graphic list. MIL.MgraClear(MIL.M_DEFAULT, MilGraphicList) # Draw bounding box MIL.MagmDraw(MIL.M_DEFAULT, MilSearchResult, MilGraphicList, MIL.M_DRAW_BOX, MIL.M_ALL, MIL.M_DEFAULT) else: print(\"The model was not found in the target image.\\n\") # Display the test image. MIL.MdispSelect(MilDisplay, TestImages[n]) # Wait for a key to be pressed. print(\"Press any key to continue.\\n\") MIL.MosGetch() # Remove the display. MIL.MdispSelect(MilDisplay, MIL.M_NULL); # Free MIL objects. for k in range(NumberOfImages): MIL.MbufFree(TestImages[k]) MIL.MgraFree(MilGraphicList) MIL.MgraFree(Regions) MIL.MagmFree(MilTrainContext) MIL.MagmFree(MilTrainResult) MIL.MagmFree(MilFindContext) MIL.MagmFree(MilSearchResult) MIL.MbufFree(TrainImagesContainer) # Composite-definition model example. def CompositeModelExample(MilSystem): print(\"This example shows that AGM is able to confidently find occurrences with appearance\") print(\"variation in a complex background after training a composite-definition model.\") print(\"Press any key to continue.\") MIL.MosGetch() #Allocate the display MilDisplay = MIL.MdispAlloc(MilSystem, MIL.M_DEFAULT, \"M_DEFAULT\", MIL.M_DEFAULT); ExecuteCompositeModelExample(MilSystem, MilDisplay, TRAIN_IMAGES_0_PATH, TEST_IMAGES_DIR_0_PATH); print(\"\\nThis second dataset shows that the positive labels can be realigned during training.\"); ExecuteCompositeModelExample(MilSystem, MilDisplay, TRAIN_IMAGES_1_PATH, TEST_IMAGES_DIR_1_PATH, 100.0); # Free the disaply MIL.MdispFree(MilDisplay) def MagmExample(): # Allocate a default MIL application, system, display and image. MilApplication, MilSystem = MIL.MappAllocDefault(MIL.M_DEFAULT, DispIdPtr=MIL.M_NULL, DigIdPtr=MIL.M_NULL, ImageBufIdPtr=MIL.M_NULL) # Print the example synopsis. print(\"[EXAMPLE NAME]\") print(\"Magm\\n\") print(\"[SYNOPSIS]\") print(\"This program shows the use of the AGM module.\\n\") print(\"[MODULES USED]\") print(\"Advanced Geometric Matcher, Buffer, Display, Graphics.\\n\") # Run single-definition model example. SingleModelExample(MilSystem) # Run composite-definition model example. CompositeModelExample(MilSystem) # Wait for a key to be pressed. print(\"Press any key to end.\") MIL.MosGetch() # Free defaults. MIL.MappFreeDefault(MilApplication, MilSystem, MIL.M_NULL, MIL.M_NULL, MIL.M_NULL) return 0 if __name__ == \"__main__\": MagmExample() ",
      "wordCount": 1556
    }
  ]
}]